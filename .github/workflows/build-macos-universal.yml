name: Build synvek on macos universal

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build-macos:
    name: Build on macos universal
    runs-on: macos-latest
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}

    steps:

    - name: Import Apple Developer Certificate
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security set-keychain-settings -t 10800 -u build.keychain
        security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
        security find-identity -v -p codesigning build.keychain
        
    - name: Verify Certificate
      run: |
        CERT_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID")
        CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
        echo "CERT_ID=$CERT_ID" >> $GITHUB_ENV
        echo "Certificate imported."

    - name: Disk space check
      run: |
        df

    - name: Install Deno
      run: |
        curl -fsSL https://deno.land/install.sh | sh
        echo "$HOME/.deno/bin" >> $GITHUB_PATH
    
    - name: Cleanup for tools
      run: |
        npm cache clean --force
        deno clean

    - name: Disk space before code checkout
      run: |
        df

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive    

    - name: Disk space after code checkout
      run: |
        df

    - name: Configure and build backend-> llama.cpp metal 
      run: |
        cmake -S third_party/llama.cpp -B build/llama.cpp/build_metal -DBUILD_SHARED_LIBS=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
        cmake --build build/llama.cpp/build_metal --config Release --target synvek_backend_llama -j 4

    - name: Copy & cleanup reasources for synvek_explorer on build backend-> llama.cpp metal 
      run: |
         mkdir output
         ls output/
         echo "Checking for source file..."
         ls -la "build/llama.cpp/build_metal/bin/libsynvek_backend_llama.dylib"
          
         echo "Copying file..."
         cp "build/llama.cpp/build_metal/bin/libsynvek_backend_llama.dylib" output/
          
         echo "Verifying copy operation..."
         ls -la output/
          
         echo "Renaming file..."
         mv "output/libsynvek_backend_llama.dylib" "output/libsynvek_backend_llama_metal.dylib"
          
         echo "Final verification..."
         ls -la output/libsynvek_backend_llama_metal.dylib
         echo "Operation completed successfully!"
         rm -rf  build/llama.cpp/build_metal

    - name: Disk space after build backend-> llama.cpp metal 
      run: |
        df

    - name: Configure and build backend-> llama.cpp cpu 
      run: |
        cmake -S third_party/llama.cpp  -B build/llama.cpp/build_cpu -DGGML_METAL=OFF  -DBUILD_SHARED_LIBS=OFF  -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
        cmake --build build/llama.cpp/build_cpu --config Release --target synvek_backend_llama -j 4

    - name: Copy & cleanup reasources for synvek_explorer on build backend-> llama.cpp cpu 
      run: |
        cp build/llama.cpp/build_cpu/bin/libsynvek_backend_llama.dylib output 
        mv output/libsynvek_backend_llama.dylib output/libsynvek_backend_llama_cpu.dylib 
        rm -rf  build/llama.cpp/build_cpu

    - name: Disk space after build backend-> llama.cpp cpu 
      run: |
        df

    - name: Configure and build backend-> stable-diffusion.cpp metal 
      run: |
        cmake -S third_party/stable-diffusion.cpp  -B build/stable-diffusion.cpp/build_metal -DSD_METAL=ON -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
        cmake --build build/stable-diffusion.cpp/build_metal --config Release --target synvek_backend_sd -j  4

    - name: Copy & cleanup reasources for synvek_explorer on build backend-> stable-diffusion.cpp metal 
      run: |
        cp build/stable-diffusion.cpp/build_metal/bin/libsynvek_backend_sd.dylib output 
        mv output/libsynvek_backend_sd.dylib output/libsynvek_backend_sd_metal.dylib 
        rm -rf  build/stable-diffusion.cpp/build_metal

    - name: Disk space after build backend-> stable-diffusion.cpp metal 
      run: |
        df
        
    - name: Configure and build backend-> stable-diffusion.cpp cpu 
      run: |
        cmake -S third_party/stable-diffusion.cpp  -B build/stable-diffusion.cpp/build_cpu -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
        cmake --build build/stable-diffusion.cpp/build_cpu --config Release --target synvek_backend_sd -j 4 

    - name: Copy & cleanup reasources for synvek_explorer on build backend-> stable-diffusion.cpp cpu 
      run: |
        cp build/stable-diffusion.cpp/build_cpu/bin/libsynvek_backend_sd.dylib output 
        mv output/libsynvek_backend_sd.dylib output/libsynvek_backend_sd_cpu.dylib 
        rm -rf  build/stable-diffusion.cpp/build_cpu

    - name: Disk space after build backend-> stable-diffusion.cpp cpu 
      run: |
        df

    - name: Configure rust for uninversal build 
      run: |
        rustup target add x86_64-apple-darwin aarch64-apple-darwin

    - name: Configure and build backend-> mistral.rs metal 
      run: |
        TAURI_TARGET="universal-apple-darwin" cargo build --profile release --target-dir build/mistral.rs/build_metal --manifest-path third_party/mistral.rs/Cargo.toml --package mistralrs-server --features "metal" --lib

    - name: Copy & cleanup reasources for synvek_explorer on build backend-> mistral.rs metal 
      run: |
        cp build/mistral.rs/build_metal/release/libsynvek_backend_default.dylib output 
        mv output/libsynvek_backend_default.dylib output/libsynvek_backend_default_metal.dylib 
        rm -rf  build/mistral.rs/build_metal

    - name: Disk space after build backend-> mistral.rs.cpp metal 
      run: |
        df

    - name: Configure and build backend-> mistral.rs cpu 
      run: |
        TAURI_TARGET="universal-apple-darwin" cargo build --profile release --target-dir build/mistral.rs/build_cpu --manifest-path third_party/mistral.rs/Cargo.toml --package mistralrs-server --lib

    - name: Copy & cleanup reasources for synvek_explorer on build backend-> mistral.rs cpu 
      run: |
        cp build/mistral.rs/build_cpu/release/libsynvek_backend_default.dylib output 
        mv output/libsynvek_backend_default.dylib output/libsynvek_backend_default_cpu.dylib 
        rm -rf  build/mistral.rs/build_cpu

    - name: Disk space after build backend-> mistral.rs.cpp cpu 
      run: |
        df
        
    - name: Configure and build synvek_web
      run: |
        npm install
        npm run desktop:build
      working-directory: ./synvek_web

    - name: Cleanup for synvek_web
      run: |
        npm cache clean --force
        rm -rf synvek_web/node_modules

    - name: Disk space after build synvek_web
      run: |
        df

    - name: Configure and build synvek_agent
      run: |
        deno install --allow-scripts=npm:ssh2@1.16.0
        deno run --unstable-sloppy-imports --unstable-worker-options  --allow-run --allow-env --allow-sys --allow-net --allow-read --allow-write  ./src/Build.ts
      working-directory: ./synvek_agent

    - name: Cleanup for synvek_agent
      run: |
        npm cache clean --force
        deno clean
        rm -rf synvek_web/node_modules

    - name: Disk space after build synvek_agent
      run: |
        df

    - name: Copy reasources for synvek_explorer
      run: |
        cp -r synvek_service/agent_plugins output 
        cp -r synvek_service/config output 
        cp -r synvek_service/service_plugins output 
        cp -r synvek_service/storage output 

    - name: Configure and build synvek_explorer
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ env.CERT_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID : ${{ secrets.APPLE_TEAM_ID  }}
      run: |
        cargo install tauri-cli --version "^2.0.0" --locked
        export DENO_SKIP_CROSS_BUILD_CHECK=1​​
        TAURI_TARGET="universal-apple-darwin" cargo tauri build --target universal-apple-darwin
      working-directory: ./synvek_explorer

    - name: Verify Universal Binary synvek_explorer
      run: |
        APP_PATH=$(find synvek_explorer/target/release/bundle -name "*.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          APP_NAME=$(basename "$APP_PATH" .app)
          BINARY_PATH="$APP_PATH/Contents/MacOS/$APP_NAME"
          
          if [ -f "$BINARY_PATH" ]; then
            echo "Binary architectures:"
            lipo -info "$BINARY_PATH"
            echo "File info:"
            file "$BINARY_PATH"
          else
            echo "Binary not found at: $BINARY_PATH"
            find "$APP_PATH" -type f
          fi
        else
          echo "No .app file found"
          find synvek_explorer/target -name "*.app" -type d
        fi      

    - name: Disk space after build synvek_agent
      run: |
        df

    - name: Copy artifacts
      run: |
        mkdir artifacts
        cp synvek_explorer/target/release/bundle/dmg/*.dmg artifacts 

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: synvek-explorer-artifacts-macos
        path: artifacts
        retention-days: 7       