name: Sync Code & Artifacts

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release Tag (Leave blank for latest)'
        required: false
        default: 'latest'
      asset_pattern:
        description: 'Asset name pattern (e.g., *.zip, *cuda*) - Leave blank for ALL assets'
        required: false
        default: ''
        
jobs:
  download_and_verify_all:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read 

    steps:
      # 1. è®¾ç½®å˜é‡å’Œç›®å½•
      - name: âš™ï¸ Set Variables and Directory
        id: vars
        run: |
          # æ›¿æ¢ä¸ºæ‚¨å¸Œæœ›ä¸‹è½½çš„ä»“åº“ï¼ˆowner/repoï¼‰
          echo "REPO=synvek/synvek" >> $GITHUB_ENV
          echo "DOWNLOAD_DIR=./artifacts" >> $GITHUB_ENV
          mkdir -p ${{ env.DOWNLOAD_DIR }}

      # 2. è½¬æ¢æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ (ä¿®å¤äº†ç®¡é“ç¬¦é—®é¢˜)
      - name: ğŸ” Convert Asset Pattern to Regex
        id: pattern_convert
        shell: bash
        # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨Shellæ¥æ‰§è¡Œå¤æ‚çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼Œè€Œä¸æ˜¯Actionsè¡¨è¾¾å¼
        run: |
          INPUT_PATTERN="${{ github.event.inputs.asset_pattern }}"
          
          # 1. å¦‚æœæ¨¡å¼ä¸ºç©ºï¼Œä½¿ç”¨ .* åŒ¹é…æ‰€æœ‰æ–‡ä»¶
          if [ -z "$INPUT_PATTERN" ]; then
            REGEX_PATTERN=".*"
          else
            # 2. å°† . è½¬ä¹‰ä¸º \.ï¼Œé¿å…å®ƒè¢«è§†ä¸ºæ­£åˆ™è¡¨è¾¾å¼çš„ä»»æ„å­—ç¬¦
            ESCAPED_DOTS=$(echo "$INPUT_PATTERN" | sed 's/\./\\\./g')
            
            # 3. å°† * é€šé…ç¬¦è½¬æ¢ä¸º .* æ­£åˆ™è¡¨è¾¾å¼
            REGEX_PATTERN=$(echo "$ESCAPED_DOTS" | sed 's/*/.\*/g')
          fi
          
          echo "Input Pattern: $INPUT_PATTERN"
          echo "Regex Pattern: $REGEX_PATTERN"
          
          # å°†æœ€ç»ˆçš„æ­£åˆ™è¡¨è¾¾å¼è®¾ç½®ç»™ä¸‹ä¸€æ­¥éª¤ä½¿ç”¨çš„è¾“å‡ºå˜é‡
          echo "regex_pattern=$REGEX_PATTERN" >> $GITHUB_OUTPUT

      # 3. è·å– Release Asset åˆ—è¡¨çš„ JSON æ•°æ®
      - name: ğŸ” Get Release Assets Data
        id: get_assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag }}
        run: |
          echo "Fetching Release Assets for tag: $TAG with pattern: ${{ steps.pattern_convert.outputs.regex_pattern }}"
          
          if [ "$TAG" == "latest" ]; then
            RELEASE_JSON=$(gh api /repos/${{ env.REPO }}/releases/latest)
          else
            RELEASE_JSON=$(gh api /repos/${{ env.REPO }}/releases/tags/${TAG})
          fi
          
          # ä½¿ç”¨ --arg å®‰å…¨åœ°å°†ä¸Šä¸€æ­¥çš„ REGEX_PATTERN ä¼ é€’ç»™ jq å˜é‡ $regex
          ASSET_DATA=$(echo "${RELEASE_JSON}" | \
            jq -r --arg regex "${{ steps.pattern_convert.outputs.regex_pattern }}" '.assets[] | 
              # ç­›é€‰é€»è¾‘ï¼šæ–‡ä»¶ååŒ¹é… $regex
              select(.name | test($regex)) |
              
              # æ ¼å¼åŒ–è¾“å‡ºï¼š name | browser_download_url | digest (å»é™¤ sha256: å‰ç¼€)
              (.name + "|" + .browser_download_url + "|" + (.digest | ltrimstr("sha256:")))'
          )
          
          if [ -z "$ASSET_DATA" ]; then
              echo "::warning::No assets found matching the pattern or the release."
              exit 0 
          fi
          
          # å°†åŒ…å«æ‰€æœ‰èµ„äº§æ•°æ®çš„å­—ç¬¦ä¸²å­˜å‚¨ä¸ºè¾“å‡ºå˜é‡ï¼ˆå¤„ç†å¤šè¡Œé—®é¢˜ï¼‰
          ASSET_DATA_OUTPUT=$(echo "$ASSET_DATA" | sed ':a;N;$!ba;s/\n/%NL%/g')
          echo "asset_list=$ASSET_DATA_OUTPUT" >> $GITHUB_OUTPUT

      # 4. å¾ªç¯ä¸‹è½½å¹¶æ ¡éªŒæ‰€æœ‰æ–‡ä»¶
      - name: â¬‡ï¸ Download and Verify Assets
        env:
          ASSET_LIST: ${{ steps.get_assets.outputs.asset_list }}
          DOWNLOAD_DIR: ${{ env.DOWNLOAD_DIR }}
        run: |
          if [ -z "$ASSET_LIST" ]; then
            echo "No assets to download."
            exit 0
          fi
          
          # å°†ç‰¹æ®Šå­—ç¬¦ %NL% æ›¿æ¢å›æ¢è¡Œç¬¦ï¼Œå¹¶ä½¿ç”¨ while å¾ªç¯å¤„ç†æ¯ä¸€è¡Œæ•°æ®
          echo "$ASSET_LIST" | sed 's/%NL%/\n/g' | while IFS="|" read -r ASSET_NAME DOWNLOAD_URL SHA256_DIGEST; do
              
              if [ -z "$ASSET_NAME" ]; then
                  continue
              fi
              
              LOCAL_PATH="$DOWNLOAD_DIR/$ASSET_NAME"
              
              echo "---"
              echo "Processing: $ASSET_NAME"
              
              # ä¸‹è½½æ–‡ä»¶
              curl -L -sS "$DOWNLOAD_URL" -o "$LOCAL_PATH"
              
              # æ ¼å¼åŒ–æ ¡éªŒå­—ç¬¦ä¸²ï¼š<SHA256>  <æ–‡ä»¶è·¯å¾„> (æ³¨æ„åŒç©ºæ ¼)
              VERIFY_STRING="${SHA256_DIGEST}  ${LOCAL_PATH}"
              
              echo "Verifying SHA256 checksum..."
              
              # ä½¿ç”¨ shasum -a 256 --check - æ ¡éªŒæ–‡ä»¶
              echo "$VERIFY_STRING" | shasum -a 256 --check -
              
              echo "âœ… $ASSET_NAME verification successful!"
          done
          echo "---"
          echo "âœ… All required assets downloaded and verified."