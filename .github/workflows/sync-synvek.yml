name: Sync Code & Artifacts

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release Tag (Leave blank for latest)'
        required: false
        default: 'latest'
      asset_pattern:
        description: 'Asset name pattern (e.g., *.zip, *cuda*) - Leave blank for ALL assets'
        required: false
        default: ''
        
jobs:
  download_and_verify_all:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read 

    steps:      
      - name:  Install GitHub CLI
        uses: actions/github-cli@v2

      - name: Set Variables
        run: |
          echo "REPO=synvek/synvek" >> $GITHUB_ENV
          echo "DOWNLOAD_DIR=./artifacts" >> $GITHUB_ENV

      - name: Set Directory
        run: |
          mkdir -p ${{ env.DOWNLOAD_DIR }}

      - name: Convert Asset Pattern to Regex
        id: pattern_convert
        shell: bash
        run: |
          INPUT_PATTERN="${{ github.event.inputs.asset_pattern }}"
          
          # 1. 如果模式为空，使用 .* 匹配所有文件
          if [ -z "$INPUT_PATTERN" ]; then
            REGEX_PATTERN=".*"
          else
            # 2. 将 . 转义为 \.，避免它被视为正则表达式的任意字符
            ESCAPED_DOTS=$(echo "$INPUT_PATTERN" | sed 's/\./\\\./g')
            
            # 3. 将 * 通配符转换为 .* 正则表达式
            REGEX_PATTERN=$(echo "$ESCAPED_DOTS" | sed 's/*/.\*/g')
          fi
          
          echo "Input Pattern: $INPUT_PATTERN"
          echo "Regex Pattern: $REGEX_PATTERN"
          
          # 将最终的正则表达式设置给下一步骤使用的输出变量
          echo "regex_pattern=$REGEX_PATTERN" >> $GITHUB_OUTPUT

      - name: Get Release Assets Data
        id: get_assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag }}
        run: |
          echo "Fetching Release Assets for tag: $TAG with pattern: ${{ steps.pattern_convert.outputs.regex_pattern }}"
          
          if [ "$TAG" == "latest" ]; then
            RELEASE_JSON=$(gh api /repos/${{ env.REPO }}/releases/latest)
          else
            RELEASE_JSON=$(gh api /repos/${{ env.REPO }}/releases/tags/${TAG})
          fi
          
          # 使用 --arg 安全地将上一步的 REGEX_PATTERN 传递给 jq 变量 $regex
          ASSET_DATA=$(echo "${RELEASE_JSON}" | \
            jq -r --arg regex "${{ steps.pattern_convert.outputs.regex_pattern }}" '.assets[] | 
              # 筛选逻辑：文件名匹配 $regex
              select(.name | test($regex)) |
              
              # 格式化输出： name | browser_download_url | digest (去除 sha256: 前缀)
              (.name + "|" + .browser_download_url + "|" + (.digest | ltrimstr("sha256:")))'
          )
          
          if [ -z "$ASSET_DATA" ]; then
              echo "::warning::No assets found matching the pattern or the release."
              exit 0 
          fi
          
          # 将包含所有资产数据的字符串存储为输出变量（处理多行问题）
          ASSET_DATA_OUTPUT=$(echo "$ASSET_DATA" | sed ':a;N;$!ba;s/\n/%NL%/g')
          echo "asset_list=$ASSET_DATA_OUTPUT" >> $GITHUB_OUTPUT

      - name: Download and Verify Assets
        env:
          ASSET_LIST: ${{ steps.get_assets.outputs.asset_list }}
          DOWNLOAD_DIR: ${{ env.DOWNLOAD_DIR }}
        run: |
          if [ -z "$ASSET_LIST" ]; then
            echo "No assets to download."
            exit 0
          fi
          
          # 将特殊字符 %NL% 替换回换行符，并使用 while 循环处理每一行数据
          echo "$ASSET_LIST" | sed 's/%NL%/\n/g' | while IFS="|" read -r ASSET_NAME DOWNLOAD_URL SHA256_DIGEST; do
              
              if [ -z "$ASSET_NAME" ]; then
                  continue
              fi
              
              LOCAL_PATH="$DOWNLOAD_DIR/$ASSET_NAME"
              
              echo "---"
              echo "Processing: $ASSET_NAME"
              
              # 下载文件
              curl -L -sS "$DOWNLOAD_URL" -o "$LOCAL_PATH"
              
              # 格式化校验字符串：<SHA256>  <文件路径> (注意双空格)
              VERIFY_STRING="${SHA256_DIGEST}  ${LOCAL_PATH}"
              
              echo "Verifying SHA256 checksum..."
              
              # 使用 shasum -a 256 --check - 校验文件
              echo "$VERIFY_STRING" | shasum -a 256 --check -
              
              echo "✅ $ASSET_NAME verification successful!"
          done
          echo "---"
          echo "✅ All required assets downloaded and verified."